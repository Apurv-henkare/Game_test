<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<title>ESCAPE PROTOCOL</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: none;
    position: fixed;
  }

  #canvas {
    display: block;
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    visibility: hidden;
    image-rendering: pixelated;
  }

  /* LOADER & START OVERLAY */
  #loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle, #0b0f1a 0%, #000000 100%);
    z-index: 100;
    cursor: pointer;
  }

  #logo {
    font-family: 'Press Start 2P', cursive;
    font-size: clamp(16px, 4vw, 28px);
    color: #00ffe7;
    text-shadow: 0 0 15px #00ffe7;
    margin-bottom: 40px;
    text-align: center;
    line-height: 1.5;
  }

  #status {
    font-family: 'Press Start 2P', cursive;
    font-size: 9px;
    color: #888;
    margin-bottom: 20px;
  }

  #barBox {
    width: 60%;
    max-width: 280px;
    height: 10px;
    background: #222;
    border-radius: 5px;
    margin-bottom: 30px;
    overflow: hidden;
    border: 1px solid #333;
  }

  #bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #00ffe7, #00b3ff);
    transition: width 0.2s;
  }

  #tapHint {
    display: none;
    font-family: 'Press Start 2P', cursive;
    font-size: 11px;
    color: #ff9900;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* ROTATE PROMPT */
  #rotatePrompt {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
    z-index: 999;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: 'Press Start 2P', cursive;
    text-align: center;
  }

  @media screen and (orientation: portrait) {
    #rotatePrompt { display: flex; }
  }
</style>
</head>

<body>

  <div id="rotatePrompt">
    <div style="font-size: 40px; margin-bottom: 20px;">ðŸ“±â†»</div>
    <div style="font-size: 10px; line-height: 2;">ROTATE TO LANDSCAPE ok<br>TO ESCAPE</div>
  </div>

  <div id="loader" onclick="startGame()">
    <div id="logo">ESCAPE PROTOCOL<br><span style="font-size: 0.5em; color: #ff9900;">THE AI PLANET</span></div>
    <div id="status">INITIALIZING...</div>
    <div id="barBox"><div id="bar"></div></div>
    <div id="tapHint">ACCESS GRANTED<br><br>TAP TO START</div>
  </div>

  <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const loader = document.getElementById("loader");
    const tapHint = document.getElementById("tapHint");
    let gameStarted = false;

    // Standard resize for coordinate alignment
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);

    function startGame() {
      // Only allow start if assets are loaded (tapHint is visible)
      if (tapHint.style.display !== "block") return;

      const el = document.documentElement;
      const rfs = el.requestFullscreen || el.webkitRequestFullScreen || el.mozRequestFullScreen || el.msRequestFullscreen;
      
      if (rfs) {
        rfs.call(el).then(() => {
          // Re-trigger resize after fullscreen transition finishes
          setTimeout(resize, 300);
          window.addEventListener('resize', detectBackNavigation);
        }).catch((err) => {
          console.log("Fullscreen blocked or failed");
        });
      }

      // iOS/Mobile Audio Unlock
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) { 
          const ctx = new AudioContext();
          if (ctx.state === 'suspended') ctx.resume();
      }

      loader.style.display = "none";
      canvas.style.visibility = "visible";
      gameStarted = true;
      resize();

      // Navigation handling
      history.pushState({playing: true}, "");
    }

    function detectBackNavigation() {
      const isFullscreen = document.fullscreenElement || document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement;
      if (gameStarted && !isFullscreen) {
        window.removeEventListener('resize', detectBackNavigation);
        window.location.href = "../index.html"; 
      }
    }

    window.onpopstate = function() {
      window.location.href = "../index.html";
    };

    // --- CRITICAL TOUCH FIX ---
    // Attaching to window ensures events are caught before browser default logic
    window.addEventListener('touchstart', e => {
      if (e.target === canvas) e.preventDefault();
    }, { passive: false });
    
    window.addEventListener('touchmove', e => {
      if (e.target === canvas) e.preventDefault();
    }, { passive: false });

    window.addEventListener('touchend', e => {
      if (e.target === canvas) e.preventDefault();
    }, { passive: false });

    // --- LOVE.JS ENGINE CONFIG ---
    var Module = {
      arguments: ["./game.love"],
      INITIAL_MEMORY: 97108864, // Kept your higher memory from Index2
      canvas: canvas,
      setStatus: function(text) {
        const s = document.getElementById("status");
        if (s) s.textContent = text;
        if (!text) {
          document.getElementById("barBox").style.display = "none";
          if (s) s.style.display = "none";
          tapHint.style.display = "block";
        }
      },
      monitorRunDependencies: function(left) {
        const total = this.totalDependencies || 0;
        const percent = total ? ((total - left) / total) * 100 : 0;
        const bar = document.getElementById("bar");
        if(bar) bar.style.width = percent + "%";
      }
    };
  </script>
  
  <script src="game.js"></script>
  <script async src="love.js" onload="Love(Module)"></script>

</body>
</html>