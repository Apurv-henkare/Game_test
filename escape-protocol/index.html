<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#000000">

<title>ESCAPE PROTOCOL - GameHub</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
*, *::before, *::after {
  box-sizing: border-box !important;
  margin: 0 !important;
  padding: 0 !important;
  -webkit-tap-highlight-color: transparent !important;
  -webkit-touch-callout: none !important;
  -webkit-user-select: none !important;
  user-select: none !important;
}

html, body {
  width: 100% !important;
  height: 100% !important;
  height: 100dvh !important;
  background: #000 !important;
  background-image: none !important;
  overflow: hidden !important;
  touch-action: none !important;
  font-family: Arial, sans-serif !important;
  position: fixed !important;
  inset: 0 !important;
}

#canvas {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  height: 100dvh !important;
  display: block !important;
  border: 0 !important;
  padding: 0 !important;
  background: #000 !important;
  -webkit-transform: translateZ(0) !important;
  transform: translateZ(0) !important;
  image-rendering: pixelated !important;
  image-rendering: crisp-edges !important;
  z-index: 1;
}

/* ========== iOS BACK BUTTON ========== */
#iosBackBtn {
  display: none;
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 99999;
  background: rgba(0,0,0,0.6);
  border: 2px solid rgba(0,255,231,0.5);
  border-radius: 50%;
  width: 44px;
  height: 44px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  transition: opacity 0.3s;
}

#iosBackBtn::after {
  content: 'âœ•';
  color: #00ffe7;
  font-size: 20px;
  font-weight: bold;
}

#iosBackBtn:active {
  background: rgba(0,255,231,0.3);
  transform: scale(0.9);
}

/* Auto-hide after 3 seconds, show on tap */
#iosBackBtn.faded {
  opacity: 0.3;
}

/* ========== SPLASH ========== */
#splash {
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at center, #0d1525 0%, #050810 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 100;
  overflow: hidden;
}

.sp-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 88%;
  max-width: 420px;
}

.sp-icon {
  font-size: clamp(2.8rem, 10vh, 4.5rem);
  line-height: 1;
}

.sp-title {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.6rem, 2.8vw, 1rem);
  color: #00ffe7;
  text-shadow: 0 0 10px #00ffe7, 0 0 25px #00b3ff55;
  margin-top: clamp(6px, 1.5vh, 14px);
  letter-spacing: 1px;
}

.sp-sub {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.3rem, 1.3vw, 0.45rem);
  color: #ff9900;
  margin-top: 4px;
}

#runBtn {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.55rem, 2.2vw, 0.85rem);
  color: #000;
  background: #00ffe7;
  border: none;
  border-radius: 50px;
  padding: clamp(12px, 2.5vh, 18px) clamp(28px, 7vw, 55px);
  cursor: pointer;
  margin-top: clamp(18px, 4vh, 35px);
  transition: transform 0.15s;
  box-shadow: 0 0 25px #00ffe755;
  animation: btnGlow 2.5s ease-in-out infinite;
  -webkit-appearance: none;
}
#runBtn:active { transform: scale(0.92); }

@keyframes btnGlow {
  0%, 100% { box-shadow: 0 0 20px #00ffe744; }
  50% { box-shadow: 0 0 35px #00ffe788, 0 0 70px #00ffe733; }
}

.sp-hint {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.25rem, 1vw, 0.35rem);
  color: #333;
  margin-top: clamp(10px, 2vh, 18px);
}

.sp-size {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.22rem, 0.9vw, 0.3rem);
  color: #282828;
  margin-top: 6px;
}

/* ========== LOADER ========== */
#loader {
  position: fixed;
  inset: 0;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: #050810 !important;
  color: white;
  z-index: 90;
}

.ld-title {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.55rem, 2.5vw, 0.9rem);
  color: #00ffe7;
  text-shadow: 0 0 8px #00ffe7;
}

.ld-sub {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.3rem, 1.2vw, 0.42rem);
  color: #ff9900;
  margin-top: 4px;
  margin-bottom: clamp(16px, 3vh, 28px);
}

.ld-bar-wrap {
  width: 78%;
  max-width: 320px;
  height: 12px;
  border-radius: 20px;
  background: #151525;
  overflow: hidden;
  border: 1px solid #252540;
}

#bar {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #00ffe7, #00b3ff);
  border-radius: 20px;
  transition: width 0.12s linear;
}

#pct {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.45rem, 2vw, 0.7rem);
  color: #00ffe7;
  margin-top: clamp(8px, 1.5vh, 14px);
}

#dlInfo {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(0.22rem, 0.9vw, 0.32rem);
  color: #444;
  margin-top: 5px;
}

.fadeOut { animation: fadeAway 0.5s forwards; pointer-events: none; }
@keyframes fadeAway { to { opacity: 0; visibility: hidden; } }

/* ========== ROTATE ========== */
#rotatePrompt {
  display: none;
  position: fixed;
  inset: 0;
  background: #000000f5 !important;
  color: white;
  font-family: 'Press Start 2P', monospace;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  text-align: center;
}
.rt-icon { font-size: clamp(2rem, 8vh, 3rem); margin-bottom: 14px; }
.rt-text { font-size: clamp(0.4rem, 1.8vw, 0.6rem); line-height: 2; }

@media (orientation: portrait) {
  #rotatePrompt { display: flex !important; }
}

footer { display: none !important; }
</style>
</head>

<body>

<!-- iOS Back Button (visible on iOS and PWA mode) -->
<div id="iosBackBtn" onclick="goToHub()"></div>

<div id="rotatePrompt">
  <div class="rt-icon">ðŸ“±â†»</div>
  <div class="rt-text">Please rotate your device<br>to landscape mode</div>
</div>

<div id="splash">
  <div class="sp-box">
    <button id="runBtn" onclick="runGame()">â–¶ RUN GAME</button>
    <div class="sp-hint">Tap to play fullscreen</div>
    <div class="sp-size">~18 MB download</div>
  </div>
</div>

<div id="loader">
  <div class="ld-title">ðŸš€ ESCAPE PROTOCOL</div>
  <div class="ld-sub">The AI Planet</div>
  <div class="ld-bar-wrap"><div id="bar"></div></div>
  <div id="pct">0%</div>
  <div id="dlInfo"></div>
</div>

<canvas id="canvas" style="visibility:hidden;"></canvas>

<script>
// ============================================================
// iOS PERFORMANCE: Cap devicePixelRatio EARLY
// On iPhone 3x DPR = 9x more pixels. Capping to 1.0 gives
// the single biggest perf win from the wrapper side.
// ============================================================
(function() {
  var IOS_MAX_DPR = 1.0;   // 1.0 = max perf; 1.5 = balance quality/perf
  var realDPR = window.devicePixelRatio || 1;
  if (realDPR > IOS_MAX_DPR) {
    Object.defineProperty(window, 'devicePixelRatio', {
      get: function() { return IOS_MAX_DPR; },
      configurable: true
    });
  }
})();


// ============================================================
// DETECT PLATFORM
// ============================================================
var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
  || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

var isStandalone = window.navigator.standalone === true
  || window.matchMedia('(display-mode: standalone)').matches
  || window.matchMedia('(display-mode: fullscreen)').matches;


// ============================================================
// BACK BUTTON â€” 3 methods for all platforms
// ============================================================
var isNavigating = false;
var weExitedFullscreen = false;

function goToHub() {
  if (isNavigating) return;
  isNavigating = true;
  window.location.replace('../index.html');
}

// METHOD 1: Fullscreen exit detection (browser mode on Android)
function onFullscreenExit() {
  if (isStandalone) return;
  var isFs = document.fullscreenElement || document.webkitFullscreenElement;
  if (!isFs && gameStarted && !weExitedFullscreen && !isNavigating) {
    goToHub();
  }
  weExitedFullscreen = false;
}
document.addEventListener('fullscreenchange', onFullscreenExit);
document.addEventListener('webkitfullscreenchange', onFullscreenExit);

// METHOD 2: History API back button (PWA standalone mode)
if (isStandalone) {
  history.pushState({ game: true }, '');
  window.addEventListener('popstate', function(e) {
    goToHub();
  });
}

// METHOD 3: On-screen back button for iOS (no hardware back button)
function showIOSBackBtn() {
  var btn = document.getElementById('iosBackBtn');
  if (!btn) return;

  // Show on iOS always, and on any device in standalone/PWA mode
  if (isIOS || isStandalone) {
    btn.style.display = 'flex';

    // Auto-fade after 4 seconds so it doesn't block gameplay
    setTimeout(function() {
      btn.classList.add('faded');
    }, 4000);

    // Show fully on any screen tap (not on the button itself)
    document.addEventListener('touchstart', function() {
      btn.classList.remove('faded');
      clearTimeout(btn._fadeTimer);
      btn._fadeTimer = setTimeout(function() {
        btn.classList.add('faded');
      }, 4000);
    });
  }
}


// ============================================================
// iOS PERFORMANCE: Pre-create optimized WebGL context
// Disabling alpha, antialias, and preserveDrawingBuffer
// removes MSAA + buffer copies + compositor blending.
// Forcing 'webgl' (not 'webgl2') avoids Safari's known
// WebGL 2 performance regressions.
// ============================================================
var _preGLContext = null;
(function() {
  var c = document.getElementById('canvas');
  if (!c) return;

  // Try WebGL 1 first (better iOS perf), fall back to webgl2
  var attrs = {
    alpha: false,                  // no blending with HTML page
    depth: true,                   // keep depth buffer for 3D
    stencil: false,                // disable if game doesn't need it
    antialias: false,              // huge mobile GPU savings
    premultipliedAlpha: false,
    preserveDrawingBuffer: false,  // allows buffer discard each frame
    powerPreference: 'high-performance',
    failIfMajorPerformanceCaveat: false
  };

  _preGLContext = c.getContext('webgl', attrs) || c.getContext('webgl2', attrs);
})();


// ============================================================
// iOS PERFORMANCE: Set canvas render resolution
// CSS size fills the screen; render target stays lower to
// reduce GPU fill rate. On 3x DPR iPhones this is critical.
// ============================================================
function setCanvasRenderSize() {
  var c = document.getElementById('canvas');
  if (!c) return;

  var w = window.innerWidth;
  var h = window.innerHeight;
  if (window.visualViewport) {
    w = Math.round(window.visualViewport.width);
    h = Math.round(window.visualViewport.height);
  }

  // Cap render resolution â€” the DPR override handles most of it,
  // but this is a safety net to keep pixel count bounded
  var maxW = 960, maxH = 540;
  var dpr = window.devicePixelRatio || 1;  // already capped by our override
  var rw = Math.round(w * dpr);
  var rh = Math.round(h * dpr);

  // Clamp if still too high (e.g. large tablets)
  if (rw > maxW || rh > maxH) {
    var scale = Math.min(maxW / rw, maxH / rh);
    rw = Math.round(rw * scale);
    rh = Math.round(rh * scale);
  }

  c.width = rw;
  c.height = rh;
}


// ============================================================
// RUN GAME
// ============================================================
var gameStarted = false;

function runGame() {
  if (gameStarted) return;
  gameStarted = true;

  if (!isStandalone) {
    enterFullscreen();
    if (isIOS) iosHideBar();
  }
  unlockAudio();
  showIOSBackBtn();

  document.getElementById('splash').style.display = 'none';
  document.getElementById('loader').style.display = 'flex';

  // iOS PERF: Set render size before engine loads
  setCanvasRenderSize();

  var s1 = document.createElement('script');
  s1.src = 'game.js';
  s1.onload = function() {
    var s2 = document.createElement('script');
    s2.src = 'love.js';
    s2.onload = function() { applicationLoad(); };
    document.body.appendChild(s2);
  };
  document.body.appendChild(s1);
}


// ============================================================
// FULLSCREEN (browser mode only)
// ============================================================
function enterFullscreen() {
  if (isNavigating) return;
  var el = document.documentElement;
  if (document.fullscreenElement || document.webkitFullscreenElement) return;
  var rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
  if (rfs) {
    rfs.call(el).then(function() {
      if (!isNavigating) { setTimeout(resizeCanvas, 100); setTimeout(resizeCanvas, 400); }
    }).catch(function() {});
  }
}


// ============================================================
// iOS SCROLL TRICK (browser mode only)
// ============================================================
function iosHideBar() {
  document.body.style.height = (window.innerHeight + 50) + 'px';
  document.body.style.overflow = 'auto';
  document.body.style.position = 'relative';
  setTimeout(function() {
    window.scrollTo(0, 1);
    setTimeout(function() {
      document.body.style.height = '100%';
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      resizeCanvas();
    }, 300);
  }, 100);
}


// ============================================================
// CANVAS RESIZE (CSS display size â€” not render target)
// ============================================================
function resizeCanvas() {
  if (isNavigating) return;
  var c = document.getElementById("canvas");
  if (!c) return;

  var w = window.innerWidth;
  var h = window.innerHeight;

  if (window.visualViewport) {
    w = Math.round(window.visualViewport.width);
    h = Math.round(window.visualViewport.height);
  }

  c.style.setProperty('width', w + 'px', 'important');
  c.style.setProperty('height', h + 'px', 'important');
  c.style.setProperty('top', '0px', 'important');
  c.style.setProperty('left', '0px', 'important');

  // iOS PERF: Also update render resolution on resize
  if (gameStarted) setCanvasRenderSize();
}

window.addEventListener("resize", function() { if (!isNavigating) resizeCanvas(); });
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', function() { if (!isNavigating) resizeCanvas(); });
}
window.addEventListener("orientationchange", function() {
  if (isNavigating) return;
  setTimeout(resizeCanvas, 100); setTimeout(resizeCanvas, 300); setTimeout(resizeCanvas, 600);
});


// ============================================================
// TOUCH PREVENTION
// ============================================================
function pv(e) {
  // Don't block touches on the back button
  if (e.target && e.target.id === 'iosBackBtn') return;
  if (gameStarted) e.preventDefault();
}
document.addEventListener('touchstart', pv, { passive: false });
document.addEventListener('touchmove', pv, { passive: false });
document.addEventListener('touchend', pv, { passive: false });
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
document.addEventListener('gesturechange', function(e) { e.preventDefault(); });
document.addEventListener('gestureend', function(e) { e.preventDefault(); });
document.addEventListener('contextmenu', function(e) { if (gameStarted) e.preventDefault(); });

var lte = 0;
document.addEventListener('touchend', function(e) {
  var n = Date.now(); if (n - lte <= 300) e.preventDefault(); lte = n;
}, { passive: false });

window.addEventListener("keydown", function(e) {
  if ([32, 37, 38, 39, 40].includes(e.keyCode)) e.preventDefault();
});


// ============================================================
// AUDIO UNLOCK (improved lifecycle for iOS)
// ============================================================
var au = false;
var _globalAudioCtx = null;

function unlockAudio() {
  if (au) return;
  try {
    _globalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var b = _globalAudioCtx.createBuffer(1, 1, 22050);
    var s = _globalAudioCtx.createBufferSource();
    s.buffer = b;
    s.connect(_globalAudioCtx.destination);
    s.start(0);
    if (_globalAudioCtx.state === 'suspended') _globalAudioCtx.resume();
  } catch(e) {}
  au = true;
}

// iOS PERF: Resume audio on interaction (iOS requires user gesture)
function resumeAllAudio() {
  try {
    if (_globalAudioCtx && _globalAudioCtx.state === 'suspended') {
      _globalAudioCtx.resume();
    }
    // Also resume Emscripten SDL2 audio context if it exists
    if (typeof Module !== 'undefined' && Module.SDL2 && Module.SDL2.audioContext) {
      if (Module.SDL2.audioContext.state === 'suspended') {
        Module.SDL2.audioContext.resume();
      }
    }
  } catch(e) {}
}

['touchstart', 'click'].forEach(function(evt) {
  document.addEventListener(evt, resumeAllAudio, { once: false, passive: true });
});


// ============================================================
// iOS PERF: Visibility API â€” pause/resume when backgrounded
// Prevents frame queue buildup that causes stutter on return.
// Suspends audio to free resources when tab is hidden.
// ============================================================
document.addEventListener('visibilitychange', function() {
  if (typeof Module === 'undefined') return;
  try {
    var sdlCtx = Module.SDL2 && Module.SDL2.audioContext;
    if (document.hidden) {
      // Suspend audio when backgrounded
      if (sdlCtx && sdlCtx.state === 'running') sdlCtx.suspend();
      if (_globalAudioCtx && _globalAudioCtx.state === 'running') _globalAudioCtx.suspend();
    } else {
      // Resume audio when foregrounded
      if (sdlCtx && sdlCtx.state === 'suspended') sdlCtx.resume();
      if (_globalAudioCtx && _globalAudioCtx.state === 'suspended') _globalAudioCtx.resume();
      // Re-sync canvas size in case orientation changed while hidden
      if (gameStarted) {
        setTimeout(resizeCanvas, 50);
        setTimeout(resizeCanvas, 300);
      }
    }
  } catch(e) {}
});


// ============================================================
// MODULE + DOWNLOAD PROGRESS
// iOS PERF additions:
//   - INITIAL_MEMORY capped at 98MB (matching original)
//   - Pre-initialized WebGL context injected
//   - print/printErr suppressed to avoid console overhead
// ============================================================
var Module = {
  arguments: ["./game.love"],
  INITIAL_MEMORY: 100663296,  
  canvas: (function() { return document.getElementById("canvas"); })(),

  // iOS PERF: Inject the pre-created optimized WebGL context
  preinitializedWebGLContext: _preGLContext,

  // iOS PERF: Suppress console output (reduces main thread work)
  print: function() {},
  printErr: function() {},

  setStatus: function(text) {
    if (isNavigating) return;

    if (!text) {
      document.getElementById("pct").textContent = "100%";
      document.getElementById("bar").style.width = "100%";
      document.getElementById("dlInfo").textContent = "Starting game...";

      var loader = document.getElementById("loader");
      var canvas = document.getElementById("canvas");
      if (loader) loader.classList.add("fadeOut");
      if (canvas) {
        canvas.style.visibility = "visible";
        setCanvasRenderSize();   // ensure render size is set
        resizeCanvas();
        if (!isStandalone) enterFullscreen();
      }

      // iOS PERF: Remove splash/loader DOM nodes entirely
      // once game is running â€” reduces compositor overhead
      setTimeout(function() {
        var splash = document.getElementById('splash');
        var loader = document.getElementById('loader');
        if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
        if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
      }, 1000);

      return;
    }

    var m = text.match(/\((\d+)\/(\d+)\)/);
    if (m) {
      var loaded = parseInt(m[1]), total = parseInt(m[2]);
      var p = Math.min(99, Math.round((loaded / total) * 100));
      document.getElementById("bar").style.width = p + "%";
      document.getElementById("pct").textContent = p + "%";
      document.getElementById("dlInfo").textContent = (loaded/1048576).toFixed(1) + " / " + (total/1048576).toFixed(1) + " MB";
    }
  },

  monitorRunDependencies: function(left) {
    var t = this.totalDependencies || 0;
    this.totalDependencies = Math.max(t, left);
  }
};

function applicationLoad() { Love(Module); }

resizeCanvas();
</script>

</body>
</html>